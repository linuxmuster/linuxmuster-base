#!/bin/sh
# setup for Linux-Musterloesung
#
# Thomas Schmitt <schmitt@lmz-bw.de>
# GPL-2

# read dist.conf
. /usr/share/linuxmuster/config/dist.conf || exit 1

# parsing parameters
opt=$1

usage() {
  echo
  echo "Usage: linuxmuster-setup <--first|--modify>"
  echo
  echo "--first : Call to do a fresh configuration. Use with caution."
  echo "          You will lose all your user data!"
  echo
  echo "--modify: Call to modify your server configuration"
  echo
  exit 1
}

[[ "$opt" = "--first" || "$opt" = "--modify" ]] || usage

# look if we were on first boot
if [ -e /etc/inittab.real ]; then

  # reread inittab
  mv /etc/inittab.real /etc/inittab
  telinit q

else

  # warning
  echo
  echo "You have called $0 with parameter $opt."
  echo "The process will start in 5 seconds. Press CRTL-C to cancel."
  n=0
  while [ $n -lt 5 ]; do
    echo -n .
    sleep 1
    let n=n+1
  done
  echo
  echo "Let's go! :-)"

fi

# reconfiguring package to have all templates
dpkg-reconfigure linuxmuster-base

# calling as base-config late command
case $opt in

  --first)

    # turn shadow passwords on
    shadowconfig on

    # delete installed flag
    [ -e "$INSTALLED" ] && rm -f $INSTALLED

    # load cdrom tray
    grep -q ^"deb cdrom" /etc/apt/sources.list && eject -t

    # installing depending tasks
    for i in common server non-free; do
      DEBIAN_FRONTEND=noninteractive /usr/bin/tasksel install linuxmuster-$i
    done

    # copying default configuration
    cp -a /var/lib/linuxmuster/config-static/* /

    ;;

  --modify)

    # check for installed flag
    if [ ! -e "$INSTALLED" ]; then
      echo "Linux-Musterloesung isn't installed yet!"
      echo "You have to use the command linuxmuster-setup --first!"
      exit 1
    fi

    [ -e $OLDVALUES ] && rm $OLDVALUES

    # read old configuration
    echo "Reading current configuration values ..."
    for i in country state location servername domainname schoolname dsluser dslpasswd smtprelay \
             internsubrange fwconfig externtype externip externmask gatewayip dnsforwarders; do
      RET=`echo get linuxmuster-base/$i | debconf-communicate`
      RET=${RET#[0-9] }
      oldvalue="${i}_old"
      echo "$oldvalue=\"$RET\"" >> $OLDVALUES
      unset RET

    done

    chmod 600 $OLDVALUES

    ;;

  *)

    usage

    ;;

esac

# ask questions
$SCRIPTSDIR/linuxmuster-config $opt || exit 1

# call configuration patch script
$SCRIPTSDIR/linuxmuster-patch $opt
